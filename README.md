## README — **metrics\_demo**

*Лёгкая асинхронная библиотека для сбора метрик на чистом C++20*

---

### 1. Кратко о задаче и принятом решении

| Пункт из ТЗ                                            | Что сделано                                                                                                                                                                            |
| ------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Добавлять новые типы метрик без переписывания кода** | `record("Любое имя", value)` — библиотеку трогать не нужно.                                                                                                                            |
| **Запись не блокирует рабочие потоки**                 | Вызов `record()` кладёт событие в lock-free кольцевой буфер (≈ 40 нс). Писать на диск — дело фонового потока.                                                                          |
| **После записи значения обнуляются**                   | После каждого flush map-агрегатор очищается.                                                                                                                                           |
| **Только STL-контейнеры, никакого стороннего кода**    | `unordered_map`, `vector`, `<thread>`, `<atomic>` — и всё.                                                                                                                             |
| **Способ записи**                                      | Выбрали **асинхронный таймер**: раз в `flush_interval` (по умолчанию 1 сек) фон записывает пачкой.<br/>– код основного потока чистый; <br/>– легко изменить интервал одним параметром. |

---

### 2. Формат строки лога

```
YYYY-MM-DD HH:MM:SS.mmm "Имя1" N1 "Имя2" N2 ...
```

В примере демо каждые 100 мс генерируются «CPU» (0-2) и «HTTP requests RPS» (0-100), а файл выглядит так:

```
2025-06-13 12:00:01.123 "CPU" 1.02 "HTTP requests RPS" 54
2025-06-13 12:00:02.124 "CPU" 0.87 "HTTP requests RPS" 48
```

---

### 3. Структура проекта

```
include/metrics.hpp      • публичный API и lock-free RingBuffer
src/metrics.cpp          • реализация
examples/main.cpp        • демонстрация (2 рабочих потока, 5 секунд работы)
tests/                   • 2 микротеста (format + latency)
```

---

### 4. Сборка & запуск

```bash
git clone https://github.com/<ВАШ_НИК>/metrics_demo.git
cd metrics_demo
cmake -B build -S .
cmake --build build          # libmetrics + example + тесты

# демо-пример
./build/example
cat metrics.log              # убедись, что строки как в ТЗ

# быстрые проверки
cmake --build build --target run-tests   # FORMAT OK!  и  record ≈ <num> ns
```

---

### 5. Использование в своём коде

```cpp
#include "metrics.hpp"

metrics::Metrics mx("app_metrics.log", std::chrono::milliseconds(500)); // flush 0.5 c
mx.record("CPU", currentCpu());
mx.record("Memory MB",  512.0);
```

В CMake достаточно подключить библиотеку:

```cmake
add_subdirectory(metrics_demo)          # если репозиторий как submodule
target_link_libraries(my_app PRIVATE metrics)
```

---

### 6. Внутри: как это работает

| Шаг                    | Что происходит                                                                                               |
| ---------------------- | ------------------------------------------------------------------------------------------------------------ |
| **record()**           | `queue_.push(std::string(name), value)` — lock-free, O(1).                                                   |
| **writerLoop()** (фон) | Каждые `interval_` выкачивает очередь, собирает `unordered_map{name → last}`, сортирует и пишет одну строку. |
| Очередь                | Bounded MPSC кольцевой буфер на 8192 слота (atomic head/tail).                                               |
| Автосброс              | После успешного вывода `store_.clear()` → новый цикл собирается «с нуля».                                    |

---

### 7. Измерения

| Тест            | Результат (M2 / Clang 17)                      |
| --------------- | ---------------------------------------------- |
| `bench_latency` | \~45 нс на вызов `record()` (1 млн итераций)   |
| `test_format`   | Строка строго соответствует шаблону из задания |

